<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ¤– BeliveHome AI åŠ©æ‰‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --text:#111; --muted:#6b7280; --brand:#22c55e; }
    * { box-sizing: border-box; }
    body{ margin:0; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{ max-width:860px; margin:36px auto; padding:0 16px; }
    .card{ background:var(--card); border-radius:16px; box-shadow:0 6px 24px rgba(0,0,0,.06); padding:20px; }
    h1{ margin:0 0 12px; font-size:28px; display:flex; gap:10px; align-items:center; }
    .chat{ display:flex; flex-direction:column; gap:10px; margin:12px 0 14px; max-height:60vh; overflow:auto; padding-right:6px;}
    .bubble{ padding:12px 14px; border-radius:14px; max-width:85%; line-height:1.5; white-space:pre-wrap;}
    .user{ align-self:flex-end; background:#e8f8ee; }
    .bot{ align-self:flex-start; background:#f3f4f6; }
    .row{ display:flex; gap:10px; }
    .ipt{ flex:1; padding:12px 14px; border:1px solid #e5e7eb; border-radius:12px; outline:none; font-size:16px; }
    .btn{ background:var(--brand); color:#fff; border:0; padding:0 18px; border-radius:12px; font-size:16px; cursor:pointer; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .muted{ color:var(--muted); font-size:13px; margin-top:8px; }
    .typing{ display:inline-flex; gap:4px; align-items:center; }
    .typing span{ width:6px; height:6px; border-radius:999px; background:#9ca3af; animation:blink 1.2s infinite; }
    .typing span:nth-child(2){ animation-delay:.2s } .typing span:nth-child(3){ animation-delay:.4s }
    @keyframes blink{ 0%,80%,100%{opacity:.2} 40%{opacity:1} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ¤– BeliveHome AI åŠ©æ‰‹</h1>

      <div id="chat" class="chat">
        <div class="bubble bot">ä½ å¥½ï¼æˆ‘æ˜¯ BeliveHome çš„ AI åŠ©æ‰‹ï¼Œå¯å›ç­”è£…ä¿®/é˜²æ°´/ææ–™é€‰æ‹©ç­‰é—®é¢˜ã€‚</div>
      </div>

      <div class="row">
        <input id="q" class="ipt" placeholder="è¯·è¾“å…¥é—®é¢˜ï¼ŒæŒ‰ Enter å‘é€â€¦" />
        <button id="send" class="btn" onclick="send()">å‘é€</button>
      </div>
      <div class="muted">æç¤ºï¼šè¯·å‹¿è¾“å…¥éšç§ä¿¡æ¯ã€‚å›ç­”ç”± AI ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒã€‚</div>
    </div>
  </div>

  <script>
  // â€”â€” å¯è‡ªå®šä¹‰çš„â€œç³»ç»Ÿæç¤ºè¯â€ï¼Œå†³å®šæœºå™¨äººè¯´è¯é£æ ¼ â€”â€” //
  const systemPrompt = "ä½ æ˜¯ BeliveHome ç½‘ç«™çš„è£…ä¿®ä¸é˜²æ°´é¡¾é—®ï¼Œè¯´è¯ä¸“ä¸šä½†äº²åˆ‡ï¼Œå›ç­”å°½é‡ç®€æ´ï¼Œå¿…è¦æ—¶ç»™æ­¥éª¤æˆ–æ¸…å•ã€‚";

  const chatEl = document.getElementById('chat');
  const qEl = document.getElementById('q');
  const sendBtn = document.getElementById('send');

  // ä¼šè¯å†å²ï¼ˆå‘ç»™åç«¯å¯å®ç°ä¸Šä¸‹æ–‡ï¼›æ­¤å¤„ç®€å•åœ¨å‰ç«¯å±•ç¤ºï¼‰
  const history = [
    { role: 'system', content: systemPrompt }
  ];

  qEl.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') send();
  });

  function appendBubble(text, role){
    const div = document.createElement('div');
    div.className = 'bubble ' + (role === 'user' ? 'user' : 'bot');
    div.innerHTML = (text||'').replace(/\n/g,'<br>');
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
    return div;
  }

  function showTyping(){
    const wrap = document.createElement('div');
    wrap.className = 'bubble bot';
    wrap.innerHTML = '<span class="typing"><span></span><span></span><span></span></span>';
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
    return wrap;
  }

  async function send(){
    const text = qEl.value.trim();
    if (!text) return;
    qEl.value = '';
    appendBubble(text, 'user');
    const typing = showTyping();
    sendBtn.disabled = true;

    try {
      // å°†ç”¨æˆ·æ¶ˆæ¯åŠ å…¥å†å²ï¼ˆå¦‚æœä»¥åè¦æŠŠå†å²ä¹Ÿå‘ç»™åç«¯ï¼Œå¯ä»¥æ‰©å±• /api/chatï¼‰
      history.push({ role:'user', content:text });

      const r = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        // å½“å‰åç«¯å®ç°åªæ¥æ”¶ messageï¼›å¦‚æœä½ æƒ³è®©åç«¯ä¹Ÿæ”¶åˆ° system/historyï¼Œå¯åœ¨åç«¯åšæ‰©å±•
        body: JSON.stringify({ message: `${text}\nï¼ˆç³»ç»Ÿæç¤ºï¼š${systemPrompt}ï¼‰` })
      });

      const data = await r.json();
      typing.remove();

      if (data.reply){
        history.push({ role:'assistant', content:data.reply });
        appendBubble(data.reply, 'bot');
      }else{
        // å‹å¥½é”™è¯¯æç¤º
        const code = data?.details?.error?.code;
        if (code === 'insufficient_quota'){
          appendBubble('âŒ ä½™é¢ä¸è¶³ï¼šè¯·åœ¨ OpenAI Billing é‡Œç»‘å¡æˆ–æ›´æ¢æœ‰é¢åº¦çš„ API Keyã€‚', 'bot');
        }else{
          appendBubble('âŒ å‡ºé”™ï¼š' + JSON.stringify(data, null, 2), 'bot');
        }
      }
    } catch (e){
      typing.remove();
      appendBubble('âŒ ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯ï¼š' + e.message, 'bot');
    } finally {
      sendBtn.disabled = false;
    }
  }
  </script>
</body>
</html>
