<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>🤖 BeliveHome AI 助手</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --text:#111; --muted:#6b7280; --brand:#22c55e; }
    * { box-sizing: border-box; }
    body{ margin:0; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{ max-width:860px; margin:36px auto; padding:0 16px; }
    .card{ background:var(--card); border-radius:16px; box-shadow:0 6px 24px rgba(0,0,0,.06); padding:20px; }
    h1{ margin:0 0 12px; font-size:28px; display:flex; gap:10px; align-items:center; }
    .chat{ display:flex; flex-direction:column; gap:10px; margin:12px 0 14px; max-height:60vh; overflow:auto; padding-right:6px;}
    .bubble{ padding:12px 14px; border-radius:14px; max-width:85%; line-height:1.5; white-space:pre-wrap;}
    .user{ align-self:flex-end; background:#e8f8ee; }
    .bot{ align-self:flex-start; background:#f3f4f6; }
    .row{ display:flex; gap:10px; }
    .ipt{ flex:1; padding:12px 14px; border:1px solid #e5e7eb; border-radius:12px; outline:none; font-size:16px; }
    .btn{ background:var(--brand); color:#fff; border:0; padding:0 18px; border-radius:12px; font-size:16px; cursor:pointer; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .muted{ color:var(--muted); font-size:13px; margin-top:8px; }
    .typing{ display:inline-flex; gap:4px; align-items:center; }
    .typing span{ width:6px; height:6px; border-radius:999px; background:#9ca3af; animation:blink 1.2s infinite; }
    .typing span:nth-child(2){ animation-delay:.2s } .typing span:nth-child(3){ animation-delay:.4s }
    @keyframes blink{ 0%,80%,100%{opacity:.2} 40%{opacity:1} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>🤖 BeliveHome AI 助手</h1>

      <div id="chat" class="chat">
        <div class="bubble bot">你好！我是 BeliveHome 的 AI 助手，可回答装修/防水/材料选择等问题。</div>
      </div>

      <div class="row">
        <input id="q" class="ipt" placeholder="请输入问题，按 Enter 发送…" />
        <button id="send" class="btn" onclick="send()">发送</button>
      </div>
      <div class="muted">提示：请勿输入隐私信息。回答由 AI 生成，仅供参考。</div>
    </div>
  </div>

  <script>
  // —— 可自定义的“系统提示词”，决定机器人说话风格 —— //
  const systemPrompt = "你是 BeliveHome 网站的装修与防水顾问，说话专业但亲切，回答尽量简洁，必要时给步骤或清单。";

  const chatEl = document.getElementById('chat');
  const qEl = document.getElementById('q');
  const sendBtn = document.getElementById('send');

  // 会话历史（发给后端可实现上下文；此处简单在前端展示）
  const history = [
    { role: 'system', content: systemPrompt }
  ];

  qEl.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') send();
  });

  function appendBubble(text, role){
    const div = document.createElement('div');
    div.className = 'bubble ' + (role === 'user' ? 'user' : 'bot');
    div.innerHTML = (text||'').replace(/\n/g,'<br>');
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
    return div;
  }

  function showTyping(){
    const wrap = document.createElement('div');
    wrap.className = 'bubble bot';
    wrap.innerHTML = '<span class="typing"><span></span><span></span><span></span></span>';
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
    return wrap;
  }

  async function send(){
    const text = qEl.value.trim();
    if (!text) return;
    qEl.value = '';
    appendBubble(text, 'user');
    const typing = showTyping();
    sendBtn.disabled = true;

    try {
      // 将用户消息加入历史（如果以后要把历史也发给后端，可以扩展 /api/chat）
      history.push({ role:'user', content:text });

      const r = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        // 当前后端实现只接收 message；如果你想让后端也收到 system/history，可在后端做扩展
        body: JSON.stringify({ message: `${text}\n（系统提示：${systemPrompt}）` })
      });

      const data = await r.json();
      typing.remove();

      if (data.reply){
        history.push({ role:'assistant', content:data.reply });
        appendBubble(data.reply, 'bot');
      }else{
        // 友好错误提示
        const code = data?.details?.error?.code;
        if (code === 'insufficient_quota'){
          appendBubble('❌ 余额不足：请在 OpenAI Billing 里绑卡或更换有额度的 API Key。', 'bot');
        }else{
          appendBubble('❌ 出错：' + JSON.stringify(data, null, 2), 'bot');
        }
      }
    } catch (e){
      typing.remove();
      appendBubble('❌ 网络或服务器错误：' + e.message, 'bot');
    } finally {
      sendBtn.disabled = false;
    }
  }
  </script>
</body>
</html>
